---
title: "Árvore de Decisão - Modelo de Machine Learning"
author: Laura Mº de Souza Romano
linkedin: https://www.linkedin.com/in/laura-maria-de-souza-romano/
database: https://archive.ics.uci.edu/dataset/222/bank+marketing 
---

``` {R Descrição do projeto}

Os dados estão relacionados com campanhas de marketing direto de uma instituição bancária portuguesa. Essas campanhas de marketing foram baseadas em telefonemas e, em muitos casos, era necessário mais do que um contato para o mesmo cliente, para saber se o produto (depósito bancário a prazo) seria ("sim") ou não ("não") adquirido.

A ideia desser projeto é criar um modelo para categorizar novoc clientes como potenciais adquiridores do produto.

Para isso, usaremos um modelo de árvore de decisão que nos permitirá tomar decisões lógicas e segmentar os clientes em grupos com maior probabilidade de adquirir o produto ("sim") ou não ("não"). As árvores de decisão são algoritmos de aprendizado de máquina que dividem o conjunto de dados em subgrupos com base nas características dos clientes, de modo que cada subgrupo seja o mais puro possível em relação à variável de destino, neste caso, a decisão de adquirir ou não o depósito bancário a prazo.

O processo de construção da árvore de decisão envolve a seleção de variáveis independentes (como idade, ocupação, estado civil, etc.) que podem ser relevantes para prever a resposta desejada. A árvore de decisão divide os dados em ramos, onde cada ramo representa uma escolha entre diferentes valores de uma variável independente. Cada folha da árvore representa uma decisão final, que neste caso seria a previsão da resposta do cliente à campanha de marketing.


```

``` {R Sumário de variáveis}

1 - age: idade (numérica)

2 - job: tipo de trabalho
(categórica: 'admin.','blue-collar','entrepreneur','housemaid',
'management','retired','self-employed','services','student','technician','unemployed','unknown')

3 - marital: estado civíl
(categórica: 'divorced','married','single','unknown'; 
note: 'divorced' means divorced or widowed)

4 - education: nível educacional
(categórica: 'basic.4y','basic.6y','basic.9y','high.school','illiterate',
'professional.course','university.degree','unknown')

5 - default: tem crédito em inadimplência?
(categórica: 'no','yes','unknown')

6 - housing: tem crédito habitação?
(categórica: 'no','yes','unknown')

7 - loan: tem empréstimo pessoal? 
(categórica: 'no','yes','unknown') 

8 - contact: tipo de comunicação de contato 
(categórica: 'cellular','telephone') 

9 - month: mês do ano de último contato
(categórica: 'jan', 'feb', 'mar', ..., 'nov', 'dec')

10 - day_of_week: dia da semana de último contato
(categórica: 'mon','tue','wed','thu','fri')

11 - duration: duração do último contato, em segundo (numérico). 
Observação importante: esse atributo afeta muito o destino de saída (por exemplo, se duração=0, então y='não'). No entanto, a duração não é conhecida antes de uma chamada ser realizada. Além disso, após o final da chamada, y é obviamente conhecido. Assim, esta entrada deve ser incluída apenas para fins de benchmark e deve ser descartada se a intenção seja ter um modelo preditivo realista.

12 - campaign: número de contactos realizados nesta campanha e para este cliente 
(numérico, inclue último contato)

13 - pdays: dias que se passaram desde que o cliente foi contatado pela última vez em uma campanha anterior 
(numérico, 999 significa que o cliente não teve contato prévio)

14 - previous: número de contactos realizados antes desta campanha e para este cliente (numérico)

15 - poutcome: resultado da campanha de marketing anterior 
(categórico: 'failure','nonexistent','success')   

16 - emp.var.rate: taxa de variação do emprego - indicador trimestral (numérico)
17 - cons.price.idx: índice de preços ao consumidor - indicador mensal (numérico)   
18 - cons.conf.idx: índice de confiança do consumidor - indicador mensal (numérico)    
19 - euribor3m: taxa euribor (indica a taxa de juros média dos empréstimos interbancários sem garantia da Zona Euro) a 3 meses - indicador diário (numérico)
20 - nr.employed: número de funcionários - indicador trimestral (numérico)
21 - y: target, diz se o cliente aderiu ou não o produto 
(categórica: 'no','yes')

```

```{R Bibliotecas utilizadas}

library(readr)
library(rsample)
library(ggplot2)
library(dplyr)
library(caret)
library(Amelia)
library(pROC)
library(rpart)
library(rpart.plot)
library(ggplot2)
library(tidyr)
```

```{r Leitura da base}

base <- read.csv2("bank-additional-full.csv")
# View(base)

```

```{r Análise das variáveis}

str(base)

```

Observamos que a maioria das variáveis se enquadra em dois tipos: inteiro (int) e caractere (chr). É necessário efetuar um ajuste nas variáveis que devem ser definidas como categóricas. Além disso, para evitar possíveis problemas, converteremos as variáveis do tipo inteiro em numéricas (num). Também iremos criar algumas variáveis a fim de facilitar nossa análise.

A seguir, demonstramos o código que realiza tais ajustes:

``` {R Ajuste na base}

# Colunas temporais:

base$month <- factor(base$month, levels = c("jan", "feb", "mar", "apr", "may", "jun",
                                            "jul", "aug", "sep", "oct", "nov", "dec"),
                     labels = c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"))

base$day_of_week <- factor(base$day_of_week, levels = c("mon", "tue", "wed", "thu", "fri", "sat", "sun"),
                           labels = c("Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"))

# Colunas categóricas:

base$job <- as.factor(base$job)
base$marital <- as.factor(base$marital)
base$education <- as.factor(base$education)
base$default <- as.factor(base$default)
base$housing <- as.factor(base$housing)
base$contact <- as.factor(base$contact)
base$poutcome <- as.factor(base$poutcome)
base$loan <- as.factor(base$loan)
base$y <- as.factor(base$y)

# Colunas numéricas:

base$age <- as.numeric(base$age)
base$duration <- as.numeric(base$duration)
base$campaign <- as.numeric(base$campaign)
base$pdays <- as.numeric(base$pdays)
base$previous <- as.numeric(base$previous)

base$emp.var.rate <- as.numeric(base$emp.var.rate)
base$cons.price.idx <- as.numeric(base$cons.price.idx)
base$cons.conf.idx <- as.numeric(base$cons.conf.idx)
base$euribor3m <- as.numeric(base$euribor3m)
base$nr.employed  <- as.numeric(base$nr.employed)


base <- base %>%
  mutate(age_range = case_when(
    age <= 18 ~ "Menos de 18",
    age <= 30 ~ "18-30",
    age <= 50 ~ "31-50",
    age <= 70 ~ "51-70",
    TRUE ~ "Mais de 70"  
    ))

base$age_range <- as.factor(base$age_range)

str(base)

```

Para o algoritmo que será empregado na categorização, é crucial que não haja valores nulos em nossa base de dados. Portanto, realizaremos uma verificação por meio do seguinte código:

``` {R Verificação valores nulos}

missing_proportions <- sapply(base, function(x) sum(is.na(x)))
print(missing_proportions)

```

############### Análise Exploratória e levantamentos estatísticos:


``` {R Dados Estatísticos - Variáveis numéricas}

colunas_numericas <- base %>% 
  select_if(is.numeric)
nome_colunas_num <- colnames(colunas_numericas) 


t(summary(colunas_numericas))

```

``` {R Distribuição - Variáveis numéricas}

par(mfrow = c(2, 5)) # subplot

for (i in nome_colunas_num) {
  hist(base[[i]], main = paste(i), xlab = i, col = "#1f78b4")
}

# Use gráficos de dispersão ou box plots para visualizar 
# a relação entre variáveis numéricas e a variável de destino.

```
Algumas informações sobre as variáveis numéricas:

- A idade média das pessoas constatadas é de 40 anos, mas há clientes na faixa dos 80-90 anos. (age)
- Em média, os cliente foram constatados aproximandamento 3 vezes até realizar sua decisão. (campaign)
- As ligações duram em médias 300 segundos, 5 minutos. (duration)
- A maior parte dos clientes não havia sido contato em campanhias anteriores. (pdays)

``` {R Boxplot das variáveis numéricas}

#for (i in nome_colunas_num) {
#  p <- ggplot(base, aes(x = y, y = !!sym(i), fill = y)) +
#    geom_boxplot() +
#    labs(title = paste("Box Plot de Target em relação à", i),
#         x = "Variável Y", 
#         y = i,
#         fill = "Variável Y") +
#    theme_minimal() +
#    scale_fill_manual(values = c("#1f78b4", "#a6cee3"))

#  print(p)
#}

# Use gráficos de dispersão ou box plots para visualizar 
# a relação entre variáveis numéricas e a variável de destino.

```


``` {R Percentual de aquisição do produto por Faixa de Idade}

a <- base %>%
  group_by(age_range, y) %>%
  summarise(n = n(), .groups = 'drop') %>% 
  mutate(Perc = (n / sum(n)) * 100)
    
p <- ggplot(a, aes(x = age_range, y = Perc, fill = y)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(Perc, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(title = paste("Percentual de aquisição do produto por faixa de idade"),
        x = i,
        y = "Percentual",
         fill = "target") +
  coord_cartesian(ylim = c(0, max(a$Perc) + 5)) +
  theme_minimal() +
  theme(legend.position = "top",
         axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("#1f78b4", "#a6cee3"))

print(p)

```
``` {R Taxa de Conversão por Faixa de Idade}

conversion_rates <- base %>%
  group_by(age_range) %>%
  summarise(conversion_rate = sum(y == "yes") / n())

conversion_rates <- conversion_rates %>%
  arrange(desc(conversion_rate))


p <- ggplot(conversion_rates, aes(x = age_range, y = conversion_rate, fill = age_range)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(conversion_rate * 100, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(title = "Percentual de Aquisição do Produto por Faixa de Idade",
       x = "Faixa de Idade",
       y = "Percentual",
       fill = "Faixa de Idade") +
  coord_cartesian(ylim = c(0, max(conversion_rates$conversion_rate) + 5)) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)) 
print(p)


```
Embora a faixa etária de 31 a 50 anos tenha registrado um maior número de clientes que adquiriram o produto, destaca-se que a taxa de conversão mais notável ocorre entre os clientes com mais de 70 anos, onde 47,6% dos indivíduos foram motivados a adquirir o produto. Em contraste, somente 9,1% dos clientes na faixa etária intermediária efetuaram a compra. Em segundo lugar, encontram-se os indivíduos com menos de 18 anos, apresentando uma elevada taxa de adesão ao produto, chegando a 42,4%.

Esses dados revelam uma tendência intrigante, especialmente quando consideramos que o produto em análise é um depósito a prazo, um instrumento financeiro que envolve a alocação de fundos a uma instituição de crédito. Nesse contexto, a instituição se compromete a reembolsar esses fundos ao cliente ao final de um período predeterminado, além de oferecer uma remuneração na forma de juros. Vamos verificar mais algumas informações.

```{R Distribuição de Profissão por Faixa de Idade}

p <- ggplot(base, aes(x = age_range, fill = job)) +
  geom_bar(position = "stack") +
  labs(title = "Distribuição de Cargos por Faixa de Idade",
       x = "Faixa de Idade",
       y = "Contagem",
       fill = "Cargo") +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p)


```
``` {R Taxa de Conversão por Profissão para cada Faixa de Idade}

age_ranges <- c("18-30", "31-50", "51-70", "Mais de 70", "Menos de 18")

for (i in age_ranges) {
  conversion_rates <- base %>%
    filter(age_range %in% c(i)) %>%
    group_by(job) %>%
    summarise(conversion_rate = sum(y == "yes") / n())
  
  conversion_rates <- conversion_rates %>%
    arrange(desc(conversion_rate))
  
  p <- ggplot(conversion_rates, aes(x = reorder(job, conversion_rate), y = conversion_rate, fill = job)) +
    geom_bar(stat = "identity", position = "dodge") +
    geom_text(aes(label = paste0(round(conversion_rate * 100, 1), "%")), 
              position = position_dodge(width = 0.9), vjust = -0.5) +
    labs(title = paste("% de Aquisição do Produto por Profissão para Faixa de Idade '", i, "'"),
         x = "Profissão",
         y = "Percentual",
         fill = "Profissão")  +
    coord_cartesian(ylim = c(0, max(conversion_rates$conversion_rate) + 5)) +
    theme_minimal() +
    theme(legend.position = "top",
          axis.text.x = element_text(angle = 45, hjust = 1)) 

print(p)

}

```

``` {R Taxa de Conversão por Nivel Educacional para cada Faixa de Idade}

age_ranges <- c("18-30", "31-50", "51-70", "Mais de 70", "Menos de 18")

for (i in age_ranges) {
  conversion_rates <- base %>%
    filter(age_range %in% c(i)) %>%
    group_by(education) %>%
    summarise(conversion_rate = sum(y == "yes") / n())
  
  conversion_rates <- conversion_rates %>%
    arrange(desc(conversion_rate))
  
  p <- ggplot(conversion_rates, aes(x = reorder(education, conversion_rate), y = conversion_rate, fill = education)) +
    geom_bar(stat = "identity", position = "dodge") +
    geom_text(aes(label = paste0(round(conversion_rate * 100, 1), "%")), 
              position = position_dodge(width = 0.9), vjust = -0.5) +
    labs(title = paste("% de Aquisição do Produto por Profissão para Faixa de Idade '", i, "'"),
         x = "Nivel Educacional",
         y = "Percentual",
         fill = "Nivel Educacional")  +
    coord_cartesian(ylim = c(0, max(conversion_rates$conversion_rate) + 5)) +
    theme_minimal() +
    theme(legend.position = "top",
          axis.text.x = element_text(angle = 45, hjust = 1)) 

print(p)

}

```
``` {R Taxa de Conversão por Nivel Educacional}

conversion_rates <- base %>%
  group_by(education) %>%
  summarise(conversion_rate = sum(y == "yes") / n())

conversion_rates <- conversion_rates %>%
  arrange(desc(conversion_rate))


p <- ggplot(conversion_rates, aes(x =  reorder(education, conversion_rate), y = conversion_rate, fill = education)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(conversion_rate * 100, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(title = "% de Aquisição do Produto por Nível Educacional",
       x = "Nível Educacional",
       y = "Percentual",
       fill = "Nível Educacional") +
  coord_cartesian(ylim = c(0, max(conversion_rates$conversion_rate) + 5)) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)) 
print(p)

```
Ao observar a faixa de idade com o menor percentual de conversão, entre 31 e 50 anos, é notável que as maiores taxas de conversão pertencem a estudantes, com 22,3%, seguidos por pessoas desempregadas, com 12%, e trabalhadores de áreas administrativas, com 11,2% de taxa de conversão.

Dentro da faixa de 51 a 70 anos, pessoas desempregadas e trabalhadores de áreas administrativas mantêm-se em segundo e terceiro lugar nas taxas de conversão, com 16,9% e 15,7%, respectivamente. A maior taxa de conversão é observada entre pessoas aposentadas, alcançando 20,3%.

Inferimos uma tendência de investimento por parte de pessoas desempregadas em produtos a prazo. Esse tipo de investimento oferece um retorno previsível e, dadas as circunstâncias de emprego, os indivíduos têm clareza sobre o prazo para reaver esses valores, caso necessário. O mesmo padrão é observado na faixa de "18-30" anos, onde 20,7% das pessoas desempregadas também realizaram a conversão.

Os trabalhadores de "blue-collar", que executam trabalhos manuais e/ou ofícios especializados, apresentam algumas das três menores taxas de conversão em quatro das cinco faixas etárias. Esse grupo pode desconhecer questões de finanças e investimentos ou direcionar seus recursos para áreas essenciais devido aos baixos salários. Nessa categoria, também podemos incluir os trabalhadores de áreas de serviços.

No tocante aos estudantes, é plausível inferir que enxergam nessa modalidade de investimento uma oportunidade para estabelecer uma reserva de emergência ou acumular recursos destinados a metas de curto prazo. Nas faixas de "31-50" e "51-70" temos uma maior adesão ao produto pessoas com niveis educacions profissionais e universitários. 

O mesmo raciocínio se aplica aos estudantes da faixa etária "Menos de 18" anos, mas nesse caso, é provável que os pais desses jovens estejam diretamente envolvidos na tomada de decisão desse investimento. A grande adesão ao nível educacional 'basic 6y', que corresponde ao término do 1.º ciclo e abrange alunos com idades aproximadas de 6 a 12 anos, coincide com o período em que os pais começam a considerar a organização de finanças para o futuro de seus filhos.

Na faixa etária "Mais de 70" anos, 83,3% são pessoas sem profissão conhecida. Entre as outras quatro posições, destacam-se os trabalhadores de gerência, com 66,7%, e os trabalhadores de áreas administrativas, com 46,9% de conversão. Inferimos que profissionais ligados à gestão e administração possam ter maior conhecimento sobre a importância da gestão financeira e dos investimentos. 

Por outro lado, os trabalhadores de limpeza apresentam uma taxa de conversão de 57,1%, enquanto os aposentados têm uma taxa de 46,9%. Esses grupos podem não possuir conhecimento aprofundado em questões financeiras e, possivelmente, tenham adquirido o produto por desconhecerem uma variedade maior de opções ou por influência direta do atendente. Ambas as profissões têm valores muito baixos de aquisição em outras faixas etárias. Outro ponto que corrobora para essa análise é que na faixa de "Mais de 70" anos, 100% das pessoas analfabetas adquiriram o porduto, seguindo de 68,2% de pessoas sem profissão conhecida, o que pode indicar a influência significativa do contato direto com os atendentes ou a falta de familiaridade com alternativas no mercado.

| Conclusões gerais:

Quanto aos idosos, com uma taxa de conversão de 47,9%, seu interesse no produto pode ser motivado pelo desejo de preservar e administrar cuidadosamente os recursos financeiros acumulados ao longo da vida. A alta taxa de conversão sugere que esse grupo demográfico percebe o depósito a prazo como uma forma segura e confiável de manter seus fundos. Além disso, para idosos que não atuam em áreas administrativas, é possível considerar que, devido à falta de conhecimento prévio em finanças e investimentos, optem por adquirir o produto sem explorar outras alternativas existentes, sendo levando pelo poder de persuasão dos atendentes.

Essa consideração pode explicar a taxa de conversão relativamente menor nas faixas etárias de 18 a 30 e de 51 a 70, onde uma parcela mais ampla da população possivelmente tenha uma base de conhecimento em finanças e investimentos, levando-os a explorar diferentes tipos de produtos financeiros para atender às suas necessidades específicas.

Para os jovens das faixas de "Menos de 18" e "18-30" anos, percebe-se nessa modalidade de investimento uma oportunidade de criar uma reserva de emergência ou acumular recursos para metas de curto prazo, como a aquisição de bens de valor ou custos associados à educação superior. Além disso, a escolha desse produto pode refletir a busca por segurança e estabilidade financeira, visto que os depósitos a prazo geralmente garantem retornos previsíveis e são considerados menos arriscados em comparação com outras formas de investimento.

Por fim, observa-se uma alta taxa de conversão de pessoas desempregadas nas faixas de "18-30", "31-50" e "51-70", devido às características deste tipo de produto e possivelmente à falta de conhecimento sobre questões financeiras e de investimento.

--

Correlações:

``` {R Análise de Correlação - Variáveis numéricas}

target <- ifelse(base$y == "yes", 1, 0) 

correlations <- sapply(colunas_numericas, function(var) cor(var, target)) 
correlation_df <- data.frame(Correlação = correlations) 
correlation_df

```
``` {R Análise de Correlação - Variáveis categóricas}

colunas_categoricas <- base %>%
  select_if(is.factor)

nome_colunas_cat <- colnames(colunas_categoricas)
nome_colunas_cat <- nome_colunas_cat[nome_colunas_cat != 'y'] # removendo a coluna 'y' (target)
nome_colunas_cat <- nome_colunas_cat[nome_colunas_cat != 'month'] # removendo a coluna 'month' (target)
nome_colunas_cat <- nome_colunas_cat[nome_colunas_cat != 'day_of_week'] # removendo a coluna 'day_of_week' (target)

resultados <- data.frame(Categoria = character(0), PValor = numeric(0))

for (i in nome_colunas_cat) {
  contingency_table <- table(base[[i]], base$y)
  chi_squared <- chisq.test(contingency_table)
  validacao <- ifelse(chi_squared$p.value < 0.05, 'Há correlação', 'Não há correlação')
  
  novo_registro <- data.frame(Categoria = i, PValor = chi_squared$p.value, Correlação = validacao)

  resultados <- rbind(resultados, novo_registro)
}

resultados

```
--

Análise Temporal (Mês)

```{R Percentual de aquisição do produto por Mês'}

a <- base %>%
  group_by(month, y) %>%
  summarise(n = n(), .groups = 'drop') %>%
  mutate(Perc = (n / sum(n)) * 100)
    
p <- ggplot(a, aes(x = month, y = Perc, fill = y)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(Perc, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(title = paste("Distribuição por", i),
       x = i,
       y = "Percentual",
       fill = "target") +
  coord_cartesian(ylim = c(0, max(a$Perc) + 5)) +
  theme_minimal() +
  theme(legend.position = "top",
         axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("#1f78b4", "#a6cee3"))

print(p)


```

``` {R Taxa de conversão x média taxa de juros para cada Mês}

conversion_rates <- base %>%
  group_by(month) %>%
  summarise(conversion_rate = sum(y == "yes") / n())

euribor3m <- base %>%
  group_by(month) %>%
  summarise(euribor3m = mean(euribor3m))

conversion_rates <- conversion_rates %>%
  left_join(euribor3m, by = "month") %>%  
  arrange(desc(conversion_rate))

p <- ggplot(conversion_rates, aes(x = reorder(month, conversion_rate), y = conversion_rate, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(conversion_rate * 100, 1), "%")), 
            position = position_dodge(width = 0.9), vjust = -0.5) +
  geom_text(aes(label = paste0(round(euribor3m, 2))), 
            position = position_dodge(width = 0.9), vjust = -3, color = "red") +
  labs(title = "% de Aquisição do Produto por Mês",
       x = "Mês",
       y = "Percentual",
       fill = "Mês") +
  coord_cartesian(ylim = c(0, max(conversion_rates$conversion_rate) + 5)) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1)) 

print(p)

```
``` {R Percentual por resposta em cada categoria - Variáveis categóricas}

#for (i in nome_colunas_cat) {
#  a <- base %>%
#    group_by(!!sym(i), y) %>%
#    summarise(n = n(), .groups = 'drop') %>%
#    mutate(Perc = (n / sum(n)) * 100)
#    
#  p <- ggplot(a, aes(x = !!sym(i), y = Perc, fill = y)) +
#    geom_bar(stat = "identity", position = "dodge") +
#    geom_text(aes(label = paste0(round(Perc, 1), "%")), 
#              position = position_dodge(width = 0.9), vjust = -0.5) +
#    labs(title = paste("Distribuição das categorias em", i, "por resposta"),
#         x = i,
#         y = "Percentual",
#         fill = "target") +
#    coord_cartesian(ylim = c(0, max(a$Perc) + 5)) +
#    theme_minimal() +
#    theme(legend.position = "top",
#          axis.text.x = element_text(angle = 45, hjust = 1)) +
#    scale_fill_manual(values = c("#1f78b4", "#a6cee3"))
#
#  print(p)
#}


```

``` {R Taxa de Conversão - Variáveis categóricas}

#for (i in nome_colunas_cat) {
#  conversion_rates <- base %>%
#    group_by(!!sym(i)) %>%
#    summarise(conversion_rate = sum(y == "yes") / n())
#  
#  conversion_rates <- conversion_rates %>%
#    arrange(desc(conversion_rate))
#  
#  print(conversion_rates)
#}

```

``` {R Percentual por resposta em cada categoria - Variáveis numéricas}

#for (i in nome_colunas_num) {
#  a <- base %>%
#    group_by(!!sym(i), y) %>%
#    summarise(n = n(), .groups = 'drop') %>%
#    mutate(Perc = (n / sum(n)) * 100)
#    
#  p <- ggplot(a, aes(x = !!sym(i), y = Perc, fill = y)) +
#    geom_bar(stat = "identity", position = "dodge") +
#    geom_text(aes(label = paste0(round(Perc, 1), "%")), 
#              position = position_dodge(width = 0.9), vjust = -0.5) +
#    labs(title = paste("Distribuição das categorias em", i, "por resposta"),
#         x = i,
#         y = "Percentual",
#         fill = "target") +
#    coord_cartesian(ylim = c(0, max(a$Perc) + 5)) +
#    theme_minimal() +
#    theme(legend.position = "top",
#          axis.text.x = element_text(angle = 45, hjust = 1)) +
#    scale_fill_manual(values = c("#1f78b4", "#a6cee3"))
#
#  print(p)
#}


```

``` {R Taxa de Conversão - Variáveis numéricas}

#for (i in nome_colunas_num) {
#  conversion_rates <- base %>%
#    group_by(!!sym(i)) %>%
#    summarise(conversion_rate = sum(y == "yes") / n())
#  
#  conversion_rates <- conversion_rates %>%
#    arrange(desc(conversion_rate))
#  
#  print(conversion_rates)
#}

```

############### Modelo ML - Árvore de Decisão:

```{r Separação dados de Treino e Teste}

set.seed(123) 
divisao <- initial_split(base, prop = 0.7)
treino <- training(divisao)
teste <- testing(divisao)

```

```{r Validação Cruzada e Modelo}

# Definindo os parâmetros de controle do treinamento:

ctrl <- trainControl(method = "cv", # validação cruzada
                     number = 10, # quantidade de folds
                     summaryFunction = twoClassSummary, # função de resumo para problemas de classif binária
                     classProbs = TRUE) # permitir a saída das probabilidades das classes

# Modelo treinado:


dtFit <- train(y ~ ., # target em relação a todos os outros parâmetros
               method = "rpart2", # usa a profundidade máxima (caso rpart, o parâmetro seria o de complexidade)
               tuneLength = 5,  # até 20 valores por nós
               trControl = ctrl, # objeto ctrl estabelecido com a validação cruzada
               metric = 'ROC', # métrica de avaliação: curva ROC
               data = treino) # utilizando o conjunto de treinamento

dtFit
# plot(dtFit)

```

``` {R Visualização da Árvore de Decisão}

rpart.plot(dtFit$finalModel,
           extra = 4, # informação extra nos nós
           type = 1, # tipo de gráfico
           box.palette = "RdYlGn") # cor dos nós

```

######## Predições:

``` {R Predições com o modelo treinado}

preddt <- predict(dtFit, teste, type = "prob") # utilizando o modelo dtFit, com a base de teste, com resultados através das probabilidades
resultdt <- as.factor(ifelse(preddt[,2] > 0.5, "yes", "no")) # preddt[,2] - coluna com as prob de 'yes'
resultdt

```
######## Desempenho do Modelo:

``` {R Matriz de Confusão}

confusionMatrix(resultdt, teste$y, positive = "yes")

```

``` {R Curva ROC AUC}

aucdf <- roc(teste$y, preddt[,2])
plot.roc(aucdf, print.thres = T) #  print.thres: descobrimos o melhor ponto de corte

```

``` {R Predições com o modelo treinado em novo ponto de corte}

# preddt <- predict(dtFit, teste, type = "prob") 
# resultdt <- as.factor(ifelse(preddt[,2] > 0.089, "yes", "no")) 

# confusionMatrix(resultdt, teste$y, positive = "yes")

```





